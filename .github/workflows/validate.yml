name: Detection Rules Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Detection Rules & Docs

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install jsonschema pyyaml

      - name: Validate JSON Files
        run: |
          echo "Validating Elastic detection rules..."
          for file in correlation-rules/elastic/*.json; do
            echo "Checking $file"
            python -c "import json; json.load(open('$file'))" || exit 1
          done
          echo "✅ All JSON files are valid"

      - name: Validate Sample Logs
        run: |
          echo "Validating sample log files..."
          for file in logs/*.json; do
            echo "Checking $file"
            python -c "import json; json.load(open('$file'))" || exit 1
          done
          echo "✅ All log files are valid"

      - name: Check Markdown Links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/mlc_config.json'
        continue-on-error: true

      - name: Validate Test Expectations
        run: |
          echo "Checking test expectations file..."
          python -c "import json; data = json.load(open('tests/expected_alerts.json')); assert 'brute_force_detection' in data; assert 'lateral_movement_detection' in data"
          echo "✅ Test expectations structure is valid"

      - name: Validate Lookup CSVs
        run: |
          echo "Validating lookup CSV files..."
          for file in lookups/*.csv; do
            echo "Checking $file"
            python -c "import csv; list(csv.DictReader(open('$file')))" || exit 1
          done
          echo "✅ All CSV files are valid"

      - name: Summary
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Elastic JSON rules: Valid" >> $GITHUB_STEP_SUMMARY
          echo "✅ Sample logs: Valid" >> $GITHUB_STEP_SUMMARY
          echo "✅ Lookup CSVs: Valid" >> $GITHUB_STEP_SUMMARY
          echo "✅ Test expectations: Valid" >> $GITHUB_STEP_SUMMARY
